# 红墨 - 技术方案文档

## 1. 项目概述

### 1.1 项目简介
红墨是一个基于 AI 的小红书图文生成器，通过一句话输入即可生成完整的小红书风格图文内容。项目采用前后端分离架构，支持多种 AI 服务商，提供灵活的配置管理和历史记录功能。

### 1.2 核心功能
- **智能大纲生成**：基于用户输入和参考图片，自动生成 6-9 页的内容大纲
- **批量图片生成**：支持封面优先生成，然后并发生成其他页面
- **历史记录管理**：完整记录生成历史，支持查看、编辑、删除
- **多服务商支持**：支持 Google Gemini、OpenAI 兼容接口等多种文本和图片生成服务
- **配置管理**：Web 界面可视化配置 API 服务商，支持多服务商切换
- **图片压缩优化**：自动生成缩略图，优化存储和传输

## 2. 技术架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端 (Vue 3)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ 首页输入  │  │ 大纲编辑  │  │ 生成结果  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ 历史记录  │  │ 设置管理  │  │ 图片预览  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
                        │ HTTP/SSE
                        ▼
┌─────────────────────────────────────────────────────────┐
│                  后端 API (Flask)                       │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │ 路由层        │  │ 服务层        │                   │
│  │ - outline    │  │ - Outline    │                   │
│  │ - image      │  │ - Image      │                   │
│  │ - history    │  │ - History    │                   │
│  │ - config     │  │              │                   │
│  └──────────────┘  └──────────────┘                   │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │ 生成器层      │  │ 工具层        │                   │
│  │ - Factory    │  │ - TextClient │                   │
│  │ - Base       │  │ - Compressor │                   │
│  │ - GoogleGenAI│  │ - GenAIClient│                   │
│  │ - OpenAI     │  │              │                   │
│  └──────────────┘  └──────────────┘                   │
└─────────────────────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Google      │  │ OpenAI      │  │ 其他兼容接口 │
│ Gemini API  │  │ Compatible   │  │             │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 2.2 技术栈

#### 后端技术栈
- **语言**: Python 3.11+
- **Web 框架**: Flask 3.0+
- **包管理**: uv (现代 Python 包管理器)
- **AI 服务**:
  - Google Gemini (文本生成)
  - Google GenAI (图片生成)
  - OpenAI 兼容接口 (文本/图片)
- **依赖管理**: pyproject.toml
- **数据存储**: 文件系统 (JSON + 图片文件)

#### 前端技术栈
- **框架**: Vue 3 + TypeScript
- **构建工具**: Vite 5.0+
- **状态管理**: Pinia 2.1+
- **路由**: Vue Router 4.2+
- **HTTP 客户端**: Axios 1.6+
- **样式**: CSS3 (模块化)

#### 部署技术
- **容器化**: Docker + Docker Compose
- **镜像**: histonemax/redink:latest
- **端口**: 12398

## 3. 后端架构

### 3.1 目录结构

```
backend/
├── app.py                 # Flask 应用入口
├── config.py             # 配置管理
├── generators/           # 图片生成器
│   ├── base.py          # 抽象基类
│   ├── factory.py       # 工厂模式
│   ├── google_genai.py  # Google GenAI 实现
│   ├── openai_compatible.py  # OpenAI 兼容实现
│   └── image_api.py     # 通用图片 API 实现
├── services/            # 业务服务层
│   ├── outline.py      # 大纲生成服务
│   ├── image.py         # 图片生成服务
│   └── history.py       # 历史记录服务
├── routes/              # API 路由
│   ├── __init__.py     # 路由注册
│   ├── outline_routes.py
│   ├── image_routes.py
│   ├── history_routes.py
│   └── config_routes.py
├── utils/               # 工具类
│   ├── text_client.py  # 文本生成客户端
│   ├── genai_client.py  # Google Gemini 客户端
│   └── image_compressor.py  # 图片压缩工具
└── prompts/             # Prompt 模板
    ├── outline_prompt.txt
    ├── image_prompt.txt
    └── image_prompt_short.txt
```

### 3.2 核心模块设计

#### 3.2.1 配置管理 (config.py)

**职责**:
- 加载和管理 YAML 配置文件
- 提供配置缓存机制
- 验证配置有效性
- 支持配置热重载

**关键方法**:
- `load_image_providers_config()`: 加载图片服务商配置
- `load_text_providers_config()`: 加载文本服务商配置
- `get_active_image_provider()`: 获取当前激活的图片服务商
- `get_image_provider_config()`: 获取指定服务商配置
- `reload_config()`: 重新加载配置

**配置结构**:
```yaml
# text_providers.yaml
active_provider: openai
providers:
  openai:
    type: openai_compatible
    api_key: sk-xxx
    base_url: https://api.openai.com/v1
    model: gpt-4o

# image_providers.yaml
active_provider: gemini
providers:
  gemini:
    type: google_genai
    api_key: AIza-xxx
    model: gemini-3-pro-image-preview
    high_concurrency: false
```

#### 3.2.2 生成器工厂 (generators/factory.py)

**设计模式**: 工厂模式 + 策略模式

**职责**:
- 根据配置创建对应的生成器实例
- 支持动态注册新的生成器类型
- 统一生成器接口

**支持的生成器类型**:
- `google_genai`: Google GenAI 图片生成
- `openai_compatible`: OpenAI 兼容接口
- `image_api`: 通用图片 API 接口

**关键方法**:
- `create(provider, config)`: 创建生成器实例
- `register_generator(name, class)`: 注册自定义生成器

#### 3.2.3 大纲生成服务 (services/outline.py)

**职责**:
- 调用文本生成 API 生成内容大纲
- 解析大纲文本为结构化数据
- 支持多模态输入（文本 + 图片）

**工作流程**:
1. 加载 Prompt 模板
2. 格式化用户输入和参考图片
3. 调用文本生成 API
4. 解析返回的大纲文本
5. 返回结构化页面列表

**关键方法**:
- `generate_outline(topic, images)`: 生成大纲
- `_parse_outline(outline_text)`: 解析大纲文本

**大纲格式**:
```
[封面] 页面描述内容

<page>

[内容] 页面描述内容

<page>

[内容] 页面描述内容
```

#### 3.2.4 图片生成服务 (services/image.py)

**职责**:
- 管理图片生成任务
- 支持封面优先 + 并发生成策略
- 自动重试机制
- 图片压缩和存储

**核心特性**:
- **两阶段生成**:
  1. 先生成封面（使用用户参考图）
  2. 使用封面作为参考，并发生成其他页面
- **并发控制**:
  - 高并发模式：最多 15 张同时生成
  - 顺序模式：逐张生成（适合有速率限制的 API）
- **自动重试**: 失败自动重试 3 次，指数退避
- **图片压缩**: 自动生成缩略图（50KB），原图压缩到 200KB 用于参考

**关键方法**:
- `generate_images(pages, task_id)`: 生成图片（生成器模式，支持 SSE）
- `_generate_single_image()`: 生成单张图片
- `retry_single_image()`: 重试单张图片
- `regenerate_image()`: 重新生成图片

**任务状态管理**:
```python
_task_states = {
    "task_id": {
        "pages": [...],
        "generated": {index: filename},
        "failed": {index: error},
        "cover_image": bytes,
        "full_outline": str,
        "user_images": [bytes],
        "user_topic": str
    }
}
```

#### 3.2.5 历史记录服务 (services/history.py)

**职责**:
- 管理生成历史记录
- 文件系统存储（JSON + 图片目录）
- 支持分页、搜索、统计

**存储结构**:
```
history/
├── index.json              # 索引文件
├── {record_id}.json        # 记录详情
└── {task_id}/              # 任务图片目录
    ├── 0.png
    ├── thumb_0.png
    ├── 1.png
    └── thumb_1.png
```

**关键方法**:
- `create_record()`: 创建记录
- `get_record()`: 获取记录
- `update_record()`: 更新记录
- `delete_record()`: 删除记录
- `list_records()`: 列表查询（分页）
- `scan_and_sync_task_images()`: 扫描并同步任务图片

### 3.3 API 路由设计

#### 路由模块化
使用 Flask Blueprint 实现模块化路由：

- **outline_routes**: 大纲生成相关
  - `POST /api/outline`: 生成大纲
  
- **image_routes**: 图片生成相关
  - `POST /api/generate`: 开始生成图片（SSE 流式返回）
  - `POST /api/regenerate`: 重新生成单张图片
  - `GET /api/images/<task_id>/<filename>`: 获取图片
  
- **history_routes**: 历史记录相关
  - `GET /api/history`: 获取历史记录列表
  - `GET /api/history/<id>`: 获取记录详情
  - `POST /api/history`: 创建记录
  - `PUT /api/history/<id>`: 更新记录
  - `DELETE /api/history/<id>`: 删除记录
  - `GET /api/history/stats`: 获取统计信息
  
- **config_routes**: 配置管理相关
  - `GET /api/config/text`: 获取文本服务商配置
  - `GET /api/config/image`: 获取图片服务商配置
  - `POST /api/config/text`: 更新文本服务商配置
  - `POST /api/config/image`: 更新图片服务商配置
  - `POST /api/config/reload`: 重新加载配置

### 3.4 工具类

#### 3.4.1 文本客户端 (utils/text_client.py)

**职责**:
- 封装文本生成 API 调用
- 支持多模态输入（文本 + 图片）
- 自动重试机制（429 错误）
- 统一错误处理

**支持的客户端类型**:
- `TextChatClient`: OpenAI 兼容接口
- `GenAIClient`: Google Gemini 原生接口

**关键特性**:
- 图片自动压缩到 200KB
- Base64 编码传输
- 详细的错误信息提示

#### 3.4.2 图片压缩工具 (utils/image_compressor.py)

**职责**:
- 压缩图片到指定大小
- 保持图片质量
- 支持 PNG/JPEG 格式

**压缩策略**:
- 缩略图：50KB（用于列表展示）
- 参考图：200KB（用于 API 传输）

## 4. 前端架构

### 4.1 目录结构

```
frontend/
├── src/
│   ├── main.ts           # 应用入口
│   ├── App.vue           # 根组件
│   ├── router/           # 路由配置
│   │   └── index.ts
│   ├── stores/           # 状态管理
│   │   └── generator.ts
│   ├── views/            # 页面组件
│   │   ├── HomeView.vue
│   │   ├── OutlineView.vue
│   │   ├── GenerateView.vue
│   │   ├── ResultView.vue
│   │   ├── HistoryView.vue
│   │   └── SettingsView.vue
│   ├── components/       # 通用组件
│   │   ├── home/
│   │   ├── history/
│   │   └── settings/
│   ├── api/              # API 封装
│   │   └── index.ts
│   ├── composables/      # 组合式函数
│   │   └── useProviderForm.ts
│   └── assets/           # 静态资源
│       └── css/
└── package.json
```

### 4.2 路由设计

```typescript
routes: [
  { path: '/', name: 'home', component: HomeView },
  { path: '/outline', name: 'outline', component: OutlineView },
  { path: '/generate', name: 'generate', component: GenerateView },
  { path: '/result', name: 'result', component: ResultView },
  { path: '/history', name: 'history', component: HistoryView },
  { path: '/history/:id', name: 'history-detail', component: HistoryView },
  { path: '/settings', name: 'settings', component: SettingsView }
]
```

### 4.3 状态管理 (Pinia)

#### Generator Store

**状态结构**:
```typescript
interface GeneratorState {
  stage: 'input' | 'outline' | 'generating' | 'result'
  topic: string
  outline: {
    raw: string
    pages: Page[]
  }
  progress: {
    current: number
    total: number
    status: 'idle' | 'generating' | 'done' | 'error'
  }
  images: GeneratedImage[]
  taskId: string | null
  recordId: string | null
  userImages: File[]
}
```

**关键 Actions**:
- `setTopic()`: 设置主题
- `setOutline()`: 设置大纲
- `updatePage()`: 更新页面内容
- `startGeneration()`: 开始生成
- `updateProgress()`: 更新进度
- `finishGeneration()`: 完成生成
- `reset()`: 重置状态

**持久化**:
- 使用 localStorage 自动保存状态
- 页面刷新后自动恢复

### 4.4 核心功能实现

#### 4.4.1 SSE 流式接收

```typescript
const eventSource = new EventSource('/api/generate')
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data)
  switch (data.event) {
    case 'progress':
      // 更新进度
      break
    case 'complete':
      // 图片生成完成
      break
    case 'error':
      // 生成失败
      break
    case 'finish':
      // 全部完成
      break
  }
}
```

#### 4.4.2 图片预览和下载

- 使用缩略图展示列表
- 点击查看原图
- 支持批量下载

## 5. 数据流

### 5.1 完整生成流程

```
用户输入主题
    │
    ▼
[前端] 调用 POST /api/outline
    │
    ▼
[后端] OutlineService.generate_outline()
    │
    ├─ 加载 Prompt 模板
    ├─ 格式化输入（文本 + 图片）
    ├─ 调用文本生成 API
    └─ 解析大纲文本
    │
    ▼
[前端] 显示大纲，用户编辑
    │
    ▼
[前端] 调用 POST /api/generate (SSE)
    │
    ▼
[后端] ImageService.generate_images()
    │
    ├─ 创建任务目录
    ├─ 生成封面（使用用户参考图）
    │   └─ 保存封面，压缩为参考图
    │
    ├─ 并发生成其他页面（使用封面作为参考）
    │   ├─ 线程池并发执行
    │   ├─ 自动重试失败项
    │   └─ 流式返回进度
    │
    └─ 完成，返回任务ID
    │
    ▼
[前端] 显示生成结果
    │
    ▼
[后端] 创建历史记录
    │
    └─ 保存到 history/{record_id}.json
```

### 5.2 配置更新流程

```
用户在设置页面修改配置
    │
    ▼
[前端] 调用 POST /api/config/text 或 /api/config/image
    │
    ▼
[后端] 更新 YAML 配置文件
    │
    ├─ 验证配置格式
    ├─ 写入文件
    └─ 调用 Config.reload_config()
    │
    ▼
[后端] 重置服务实例
    │
    ├─ reset_image_service()
    └─ 下次调用时重新初始化
```

## 6. 部署方案

### 6.1 Docker 部署

**Dockerfile 策略**:
- 多阶段构建
- 前端构建产物打包到后端镜像
- 单容器部署

**docker-compose.yml**:
```yaml
services:
  redink:
    image: histonemax/redink:latest
    ports:
      - "12398:12398"
    volumes:
      - ./history:/app/history
      - ./output:/app/output
    restart: unless-stopped
```

### 6.2 数据持久化

**挂载目录**:
- `./history`: 历史记录和图片
- `./output`: 生成输出（可选）

**配置文件**:
- 支持挂载自定义配置文件
- 或通过 Web 界面配置

### 6.3 开发环境

**后端启动**:
```bash
uv run python -m backend.app
```

**前端启动**:
```bash
cd frontend
pnpm dev
```

## 7. 技术选型说明

### 7.1 后端选型

**Flask vs FastAPI**:
- 选择 Flask：更成熟，生态丰富，适合快速开发
- 轻量级，易于扩展

**uv vs pip**:
- 选择 uv：更快的依赖解析和安装
- 现代化的 Python 包管理

**文件存储 vs 数据库**:
- 选择文件存储：简单直接，无需额外依赖
- JSON + 文件系统适合中小规模数据

### 7.2 前端选型

**Vue 3 vs React**:
- 选择 Vue 3：更简洁的 API，更好的开发体验
- Composition API 适合复杂状态管理

**Pinia vs Vuex**:
- 选择 Pinia：Vue 3 官方推荐
- TypeScript 支持更好

**Vite vs Webpack**:
- 选择 Vite：更快的开发服务器
- 更好的 HMR 体验

### 7.3 AI 服务选型

**多服务商支持**:
- 降低单点依赖风险
- 用户可根据需求选择
- 支持成本优化

**工厂模式设计**:
- 易于扩展新的服务商
- 统一接口，降低耦合

## 8. 性能优化

### 8.1 图片优化

- **缩略图生成**: 列表展示使用 50KB 缩略图
- **参考图压缩**: API 传输前压缩到 200KB
- **懒加载**: 前端图片懒加载

### 8.2 并发控制

- **高并发模式**: 最多 15 张同时生成
- **顺序模式**: 适合有速率限制的 API
- **自动重试**: 指数退避策略

### 8.3 缓存策略

- **配置缓存**: 内存缓存配置，减少文件读取
- **任务状态缓存**: 内存中维护任务状态

## 9. 安全考虑

### 9.1 API Key 管理

- **脱敏显示**: 前端显示时隐藏部分字符
- **文件权限**: 配置文件权限控制
- **环境变量**: 支持环境变量覆盖（未来）

### 9.2 输入验证

- **文件类型验证**: 限制上传文件类型
- **大小限制**: 限制上传文件大小
- **路径安全**: 防止路径遍历攻击

### 9.3 CORS 配置

- **白名单机制**: 仅允许指定域名访问
- **开发环境**: 支持 localhost 访问

## 10. 扩展性设计

### 10.1 生成器扩展

**添加新生成器**:
1. 继承 `ImageGeneratorBase`
2. 实现 `generate_image()` 方法
3. 在工厂中注册

### 10.2 服务商扩展

**添加新服务商**:
1. 在配置文件中添加服务商配置
2. 实现对应的客户端或生成器
3. 无需修改核心代码

### 10.3 功能扩展

**未来可扩展功能**:
- 导出为 PDF
- 导出为长图
- 批量处理
- 模板管理
- 用户系统

## 11. 监控和日志

### 11.1 日志系统

**日志级别**:
- DEBUG: 详细调试信息
- INFO: 关键操作记录
- WARNING: 警告信息
- ERROR: 错误信息

**日志格式**:
```
时间 | 级别 | 模块名
  └─ 消息内容
```

### 11.2 错误处理

**统一错误格式**:
- 详细的错误信息
- 解决方案提示
- 错误码（未来）

## 12. 总结

红墨项目采用现代化的技术栈和清晰的架构设计，实现了：

1. **模块化设计**: 路由、服务、生成器分层清晰
2. **可扩展性**: 工厂模式支持轻松添加新服务商
3. **用户体验**: 流式进度更新，实时反馈
4. **部署简单**: Docker 一键部署
5. **配置灵活**: Web 界面可视化配置

项目代码结构清晰，易于维护和扩展，适合作为 AI 应用开发的参考架构。

